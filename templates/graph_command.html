<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Neo4j Query Visualization</title>
    <!-- å¼•å…¥D3.jsæˆ–å…¶ä»–å¯è§†åŒ–åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.0/cytoscape.min.js"></script>

    <style>
   body {
    font-family: 'Arial', sans-serif;
    background-color: #f4f4f7;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
}

.container {
    width: 90%;
    max-width: 1200px;
    background-color: white;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    padding: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.input-group {
    display: flex;
    width: 100%;
    margin-bottom: 20px;
}

#cypherQuery {
    flex-grow: 1;
    padding: 12px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 25px 0 0 25px;
    font-size: 16px;
    transition: all 0.3s ease;
}

#cypherQuery:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 10px rgba(74, 144, 226, 0.2);
}

button {
    padding: 12px 25px;
    background-color: #4a90e2;
    color: white;
    border: none;
    border-radius: 0 25px 25px 0;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

button:hover {
    background-color: #357abd;
}

#cy {
    width: 100%;
    height: 600px;
    border: 3px solid #e0e0e0;
    border-radius: 15px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

#cy:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

#visualization {
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background-color: #f9f9f9;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
}

        .section-title {
            width: 100%;
            text-align: left;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a90e2;
            color: #333;
            font-weight: bold;
            font-size: 18px;
        }

        .query-description {
            width: 100%;
            background-color: #f0f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }
</style>
</head>
<body>
   <div class="container">
        <h1 class="section-title">ğŸ” Neo4j Graph Query Visualization</h1>

        <div class="query-description">
            åœ¨æ­¤è¾“å…¥CypheræŸ¥è¯¢è¯­å¥ï¼Œæ¢ç´¢å›¾æ•°æ®åº“ä¸­çš„å…³ç³»å’ŒèŠ‚ç‚¹ã€‚æ³¨æ„ä¸è¦è¿”å›æ•´ä¸ªæœç´¢ç»“æœã€‚ä¸ç„¶æ•°æ®é‡å¤ªå¤§ã€‚ä¾‹å¦‚ï¼š
            <ul>
                <li>MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 25</li>
                <li>MATCH (p:Person)-[r1:é¥°æ¼”]->(m:Movie) RETURN p,r1,m limit 30</li>
            </ul>
        </div>

        <div class="section-title">å‘½ä»¤æŸ¥è¯¢è¾“å…¥</div>
        <div class="input-group">
            <input
                type="text"
                id="cypherQuery"
                placeholder="è¾“å…¥CypheræŸ¥è¯¢è¯­å¥ï¼Œå¦‚ï¼šMATCH (n) RETURN n LIMIT 10"
            >
            <button onclick="executeQuery()">æ‰§è¡ŒæŸ¥è¯¢</button>
        </div>


        <div class="section-title">æŸ¥è¯¢åŸå§‹æ•°æ®</div>
        <div id="visualization"></div>

        <div class="section-title">å›¾å½¢å¯è§†åŒ–</div>
        <div id="cy"></div>
    </div>
    <script>
        function executeQuery() {
            const query = document.getElementById('cypherQuery').value;
            fetch('/graph/query_command_main', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cypher_query: query })
            })
            .then(response => response.json())
            .then(data => visualizeData(data))
            .catch(error => console.error('Error:', error));
        }


        function visualizeData(data) {
                 console.log('Received data:', data); // è°ƒè¯•ä¿¡æ¯
                 document.getElementById('visualization').innerText = JSON.stringify(data, null, 2);
                // å°†Neo4jæŸ¥è¯¢ç»“æœè§£æä¸ºCytoscape.jså¯è¯†åˆ«çš„æ ¼å¼
                const elements = [];
                const nodeIds = new Set(); // ç”¨äºè·Ÿè¸ªå·²æ·»åŠ çš„èŠ‚ç‚¹IDï¼Œé˜²æ­¢é‡å¤æ·»åŠ 

                // æ·»åŠ èŠ‚ç‚¹
                data.nodes.forEach(node => {
                      const displayProperty = getnodePropertyToDisplay(node.label, node.properties);
                    if (!nodeIds.has(node.id)) {
                        elements.push({
                            group: 'nodes',
                            data: {
                                id: node.id,
                                label: node.label,
                                property:node.properties,
                                content:displayProperty
                            }
                        });
                        nodeIds.add(node.id);
                    }
                });

                // æ·»åŠ è¾¹ï¼Œå¹¶ç¡®ä¿æ¶‰åŠçš„èŠ‚ç‚¹å·²ç»å­˜åœ¨
                data.edges.forEach(edge => {
                    const sourceId = edge.from;
                    const targetId = edge.to;

                    // ç¡®ä¿æºå’Œç›®æ ‡èŠ‚ç‚¹éƒ½å·²ç»è¢«æ·»åŠ 
                    if (!nodeIds.has(sourceId)) {
                        console.warn(`Source node ${sourceId} not found, skipping edge.`);
                        return;
                    }
                    if (!nodeIds.has(targetId)) {
                        console.warn(`Target node ${targetId} not found, skipping edge.`);
                        return;
                    }

                    elements.push({
                        group: 'edges',
                        data: {
                            id: `${sourceId}-${targetId}-${edge.label}`, // åˆ›å»ºå”¯ä¸€çš„è¾¹ID
                            source: sourceId,
                            target: targetId,
                            label: edge.label,

                        }
                    });
                });

                // åˆå§‹åŒ–Cytoscapeå®ä¾‹
                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                      layout: {
                                name: 'cose',
                                // ä¼˜åŒ–å¸ƒå±€å‚æ•°
                                idealEdgeLength: 200,       // å¢åŠ ç†æƒ³è¾¹é•¿
                                nodeOverlap: 20,
                                refresh: 20,
                                fit: true,
                                padding: 30,
                                randomize: false,
                                componentSpacing: 100,
                                nodeRepulsion: 400000,
                                edgeElasticity: 100,
                                nestingFactor: 5,
                                gravity: 80,
                                numIter: 1000,
                                initialTemp: 200,
                                coolingFactor: 0.95,
                                minTemp: 1.0
                            },
                    style: [
                        {
                            selector: 'node[label="Genre"]',
                            style: {
                                'background-color':  '#4169E1',
                                'label': 'data(content)', // å‡è®¾æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰nameå±æ€§
                                'text-wrap': 'wrap'
                            }
                        },
                         {
                            selector: 'node[label="Person"]',
                            style: {
                                'background-color': '#7FFFD4',
                                'label': 'data(content)',
                                 'text-wrap': 'wrap'// å‡è®¾æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰nameå±æ€§
                            }
                        },

                         {
                            selector: 'node[label="Movie"]',
                            style: {
                                'background-color': '#8B4513',
                                'label': 'data(content)',
                                 'text-wrap': 'wrap'// å‡è®¾æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰nameå±æ€§
                            }
                        },
                         {
                                    selector: 'edge',
                                    style: {
                                        'curve-style': 'bezier',
                                        'font-size': '10px',
                                        'text-rotation': 'autorotate',
                                        'target-arrow-shape': 'vee',
                                        'arrow-scale': 1.5,
                                        'line-height': 1.2,
                                        'text-margin-y': -10,
                                        'width': 2,
                                        'edge-distances': 'node-position'
                                    }
                         },

                        {
                            selector: 'edge[label="æ˜¯"]',
                            style: {
                                'width': 3,
                                'line-color': '#CD5555',
                                'target-arrow-color': '#CDAD00',
                                'target-arrow-shape': 'triangle',
                                'arrow-scale': 1, // å¯é€‰ï¼šè°ƒæ•´ç®­å¤´å¤§å°
                                'label': 'data(label)' // æ˜¾ç¤ºè¾¹çš„æ ‡ç­¾
                            }
                        },
                         {
                            selector: 'edge[label="é¥°æ¼”"]',
                            style: {
                                'width': 3,
                                'line-color': '#FF34B3',
                                'target-arrow-color': '#8B8970',
                                'target-arrow-shape': 'triangle',
                                'arrow-scale': 1, // å¯é€‰ï¼šè°ƒæ•´ç®­å¤´å¤§å°
                                'label': 'data(label)' // æ˜¾ç¤ºè¾¹çš„æ ‡ç­¾
                            }
                        },

                    ]
                });
                cy.ready(function() {
                    cy.fit(); // è‡ªåŠ¨è°ƒæ•´è§†å›¾ä»¥é€‚åº”æ‰€æœ‰å…ƒç´ 
                });
        }

        function getnodePropertyToDisplay(label, properties) {
                switch (label) {
                    case 'Genre':
                        return properties.name || 'Unknown Person'; // å¦‚æœæœ‰nameå±æ€§åˆ™ä½¿ç”¨å®ƒï¼Œå¦åˆ™ç”¨é»˜è®¤æ–‡æœ¬
                    case 'Person':
                        return properties.name || 'Unknown Company';
                    case 'Movie':
                        return properties.title || 'Untitled Project';
                    default:
                        return JSON.stringify(properties); // é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†æ•´ä¸ªpropertieså¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                }
        }
        //MATCH (n)-[r]->(m) RETURN n,r,m LIMIT 25
    </script>
</body>
</html>